/**
 * æ›´æ–°æ£€æŸ¥ç»„ä»¶ç¤ºä¾‹
 *
 * ä½¿ç”¨æ–¹æ³•:
 * 1. å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º UpdateChecker.tsx
 * 2. åœ¨ä¸»åº”ç”¨ä¸­å¯¼å…¥å¹¶ä½¿ç”¨
 */

import { useState, useEffect } from 'react';
import { checkForUpdates, installUpdate } from '../lib/tauri';

export function UpdateChecker() {
  const [updateAvailable, setUpdateAvailable] = useState(false);
  const [checking, setChecking] = useState(false);
  const [installing, setInstalling] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
  useEffect(() => {
    handleCheckUpdate();
  }, []);

  const handleCheckUpdate = async () => {
    setChecking(true);
    setError(null);
    try {
      const hasUpdate = await checkForUpdates();
      setUpdateAvailable(hasUpdate);
      if (hasUpdate) {
        console.log('å‘ç°æ–°ç‰ˆæœ¬!');
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'æ£€æŸ¥æ›´æ–°å¤±è´¥');
      console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', err);
    } finally {
      setChecking(false);
    }
  };

  const handleInstallUpdate = async () => {
    setInstalling(true);
    setError(null);
    try {
      await installUpdate();
      // æ›´æ–°ä¼šè‡ªåŠ¨é‡å¯åº”ç”¨
    } catch (err) {
      setError(err instanceof Error ? err.message : 'å®‰è£…æ›´æ–°å¤±è´¥');
      console.error('å®‰è£…æ›´æ–°å¤±è´¥:', err);
      setInstalling(false);
    }
  };

  if (!updateAvailable && !error) {
    return null; // æ²¡æœ‰æ›´æ–°æ—¶ä¸æ˜¾ç¤º
  }

  return (
    <div className="update-banner">
      {updateAvailable && (
        <div className="update-available">
          <p>ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬!</p>
          <button
            onClick={handleInstallUpdate}
            disabled={installing}
          >
            {installing ? 'æ­£åœ¨å®‰è£…...' : 'ç«‹å³æ›´æ–°'}
          </button>
          <button onClick={() => setUpdateAvailable(false)}>
            ç¨åæé†’
          </button>
        </div>
      )}

      {error && (
        <div className="update-error">
          <p>âŒ {error}</p>
          <button onClick={handleCheckUpdate}>é‡è¯•</button>
        </div>
      )}

      <button
        onClick={handleCheckUpdate}
        disabled={checking}
        className="check-update-btn"
      >
        {checking ? 'æ£€æŸ¥ä¸­...' : 'æ£€æŸ¥æ›´æ–°'}
      </button>
    </div>
  );
}
